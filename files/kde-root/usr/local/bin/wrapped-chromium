#! /bin/bash

BIN=/usr/bin/chromium
EXTRA_FLAGS=(${CHROMIUM_FLAGS:-})

# Cleanup
if ! pgrep chromium > /dev/null;then
  rm -f $HOME/.config/chromium/Singleton*
fi

# Detect GPU availability
if [ "${CHROMIUM_USE_GPU}" = "true" ] || [ -d "/dev/dri" ] || [ -e "/dev/nvidia0" ]; then
  # Use hardware GPU with WebGL support
  DEFAULT_FLAGS="--disable-dev-shm-usage --password-store=basic --enable-gpu-rasterization --enable-features=VaapiVideoDecoder,VaapiVideoEncoder --use-gl=angle --use-angle=gl"
else
  # Fallback to software rendering
  DEFAULT_FLAGS="--disable-dev-shm-usage --disable-gpu --use-gl=swiftshader --password-store=basic"
fi

# Run normally on privved containers or modified un non priv
if grep -q 'Seccomp:.0' /proc/1/status; then
  ${BIN} ${DEFAULT_FLAGS} "${EXTRA_FLAGS[@]}" "$@"
else
  ${BIN} ${DEFAULT_FLAGS} --no-sandbox --test-type "${EXTRA_FLAGS[@]}" "$@"
fi
